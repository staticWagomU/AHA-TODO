---
import { getTodos, writeTodos, type Todo } from "../../todoFileOperations";

export const partial = true;
const { id } = Astro.params;
try {
  const todos = getTodos();

  const requestMethod = Astro.request.method;
  if (requestMethod === "PUT") {
    // idが一致するtodoのcompleteを反転させる
    const newTodos = todos.map((todo: Todo) => {
      if (todo.id === Number(id)) {
        return { ...todo, complete: !todo.complete };
      }
      return todo;
    });
    writeTodos(newTodos);
    Astro.response.status = 300;
  } else if (requestMethod === "DELETE") {
    // idが一致するtodoを削除する
    const newTodos = todos.filter((todo: Todo) => todo.id !== Number(id));
    writeTodos(newTodos);
    Astro.response.status = 200;
  } else if (requestMethod === "PATCH") {
    const json = await Astro.request.json();
    const title = json.title;
    if (typeof title !== "string") throw new Error("title is not string");
    const newTodos = todos.map((todo: Todo) => {
      if (todo.id === Number(id)) {
        return { ...todo, title: title };
      }
      return todo;
    });
    writeTodos(newTodos);
    Astro.response.status = 200;
  } else {
    Astro.response.status = 405;
    throw new Error("Method not allowed");
  }
} catch (error) {
  console.error(error);
}
---
